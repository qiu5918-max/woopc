---
import { CURRENT_SUBDOMAIN, API_BASE } from '../lib/tenant-config';

// 从 API 获取案例数据
async function getCases() {
  try {
    const res = await fetch(`${API_BASE}/api/v1/public/${CURRENT_SUBDOMAIN}/cases`, {
      headers: { 'Content-Type': 'application/json' }
    });
    if (!res.ok) return [];
    const data = await res.json();
    return data.data || [];
  } catch (error) {
    console.error('Failed to fetch cases:', error);
    return [];
  }
}

const apiCases = await getCases();

// 默认案例数据
const defaultCases = [
  {
    title: '某制造企业AI智能体落地',
    background: '需落地AI智能体提升办公效率，存在"技术与业务脱节、团队不会用"的痛点',
    approach: ['深度调研业务场景', '定制轻量化AI方案', '落地+数据打通', '团队实操培训'],
    results: [
      { value: '40%', label: '办公效率提升' },
      { value: '95%', label: 'AI工具使用率' }
    ],
    category: 'ai-enterprise',
    featured: true
  },
  {
    title: '某政府产业园区AI+数字化',
    background: '需落地AI智能体优化招商与企业服务，存在"数据割裂、服务效率低"的痛点',
    approach: ['整合园区数据', '定制AI智能体', '合规落地+系统对接'],
    results: [
      { value: '50%', label: '企业对接效率' },
      { value: '60%', label: '数据管理效率' }
    ],
    category: 'ai-enterprise',
    featured: true
  },
  {
    title: '个人心脑血管慢病管理',
    background: '45岁上班族，高血压高危因素，工作繁忙，无时间做系统健康管理',
    approach: ['数据化监测核心指标', '定制饮食/作息方案', '数字化打卡+30天跟进'],
    results: [
      { value: '正常', label: '30天血压' },
      { value: '5分钟', label: '每日监测' }
    ],
    category: 'health-management',
    featured: false
  },
  {
    title: '企业员工健康管理',
    background: '需为员工做心脑血管健康管理，存在"人数多、需求分散、效率低"的痛点',
    approach: ['定制健康数字化体系', 'AI工具辅助监测', '批量方案定制+答疑'],
    results: [
      { value: '80%', label: '健康知晓率' },
      { value: '90%+', label: '员工满意度' }
    ],
    category: 'health-management',
    featured: true
  },
  {
    title: '大健康机构AI智能化升级',
    background: '需提升心脑血管健康管理效率，存在"人工咨询量大、方案定制慢"的痛点',
    approach: ['定制AI智能体', '咨询自动化', '健康数据打通与监测'],
    results: [
      { value: '70%', label: '咨询效率提升' },
      { value: '60%', label: '用户量提升' }
    ],
    category: 'ai-health-fusion',
    featured: true
  }
];

// 使用 API 数据或默认数据
const cases = apiCases.length > 0 ? apiCases.map((c: any) => ({
  title: c.title,
  background: c.background || '',
  approach: c.approach || [],
  results: c.results?.metrics || [],
  category: c.category || 'other',
  featured: c.featured || false
})) : defaultCases;

// 精选案例（优先显示）
const featuredCases = cases.filter((c: any) => c.featured);
const regularCases = cases.filter((c: any) => !c.featured);
const displayCases = featuredCases.length > 0 ? featuredCases : cases.slice(0, 3);
---

<section id="cases" class="section relative overflow-hidden">
  <!-- 背景装饰 -->
  <div class="absolute inset-0 bg-gradient-to-b from-background to-surface"></div>
  <div class="absolute top-0 right-0 w-96 h-96 bg-accent/5 rounded-full blur-3xl"></div>
  <div class="absolute bottom-0 left-0 w-96 h-96 bg-secondary/5 rounded-full blur-3xl"></div>

  <div class="container relative z-10">
    <!-- 标题 -->
    <div class="text-center mb-12">
      <span class="data-badge mb-4 inline-flex">实战案例</span>
      <h2 class="section-title mb-3">落地案例</h2>
      <p class="section-subtitle">用结果说话，每一个案例都是真实交付</p>
    </div>

    <!-- 案例卡片网格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {displayCases.map((caseItem: any, index: number) => (
        <div class="card group hover:shadow-xl transition-all duration-300 flex flex-col">
          <!-- 顶部彩色条 -->
          <div class={`h-1.5 rounded-t-xl ${
            index % 3 === 0 ? 'bg-gradient-to-r from-accent to-purple-500' :
            index % 3 === 1 ? 'bg-gradient-to-r from-secondary to-emerald-400' :
            'bg-gradient-to-r from-primary to-yellow-400'
          }`}></div>

          <div class="p-5 flex-1 flex flex-col">
            <!-- 案例标题 -->
            <h3 class="text-lg font-bold text-text-primary mb-3 group-hover:text-accent transition-colors">
              {caseItem.title}
            </h3>

            <!-- 项目背景 -->
            <div class="mb-4 flex-1">
              <div class="flex items-start gap-2">
                <svg class="w-4 h-4 text-text-secondary mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-sm text-text-secondary leading-relaxed">{caseItem.background}</p>
              </div>
            </div>

            <!-- 核心做法 - 横向流程 -->
            <div class="mb-5">
              <div class="flex items-center gap-1.5 mb-2">
                <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
                <span class="text-xs font-medium text-text-secondary">解决方案</span>
              </div>
              <div class="flex flex-wrap gap-1.5">
                {caseItem.approach.map((step: string, i: number) => (
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-surface text-xs text-text-secondary">
                    <span class={`w-4 h-4 rounded text-[10px] flex items-center justify-center font-medium ${
                      index % 3 === 0 ? 'bg-accent/10 text-accent' :
                      index % 3 === 1 ? 'bg-secondary/10 text-secondary' :
                      'bg-primary/10 text-primary'
                    }`}>{i + 1}</span>
                    {step}
                  </span>
                ))}
              </div>
            </div>

            <!-- 落地结果 -->
            <div class="pt-4 border-t border-border/30">
              <div class="flex items-center gap-1.5 mb-3">
                <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs font-medium text-text-secondary">交付结果</span>
              </div>
              <div class="grid grid-cols-2 gap-2">
                {caseItem.results.slice(0, 4).map((result: any) => (
                  <div class="text-center p-2 rounded-lg bg-gradient-to-br from-accent/5 to-purple-500/5 dark:from-accent/10 dark:to-purple-500/10">
                    <p class={`text-lg font-bold ${
                      index % 3 === 0 ? 'text-accent' :
                      index % 3 === 1 ? 'text-secondary' : 'text-primary'
                    }`}>{result.value}</p>
                    <p class="text-[10px] text-text-secondary leading-tight">{result.label}</p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- 如果有更多案例，显示查看更多 -->
    {regularCases.length > 0 && featuredCases.length > 0 && (
      <div class="text-center mt-8">
        <a href="#contact" class="btn btn-accent text-sm">
          查看更多案例
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a>
      </div>
    )}
  </div>
</section>

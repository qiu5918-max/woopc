---
// API 配置
const API_BASE = import.meta.env.API_BASE || 'http://101.42.36.114:5919';
const SUBDOMAIN = 'www';

// 从 API 获取案例数据
async function getCases() {
  try {
    const res = await fetch(`${API_BASE}/api/v1/public/${SUBDOMAIN}/cases`, {
      headers: { 'Content-Type': 'application/json' }
    });
    if (!res.ok) return [];
    const data = await res.json();
    return data.data || [];
  } catch (error) {
    console.error('Failed to fetch cases:', error);
    return [];
  }
}

// 默认图标映射
const categoryIcons: Record<string, string> = {
  'ai-enterprise': `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
  </svg>`,
  'health-management': `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
  </svg>`,
  'ai-health-fusion': `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z" />
  </svg>`
};

const categoryTitles: Record<string, string> = {
  'ai-enterprise': '企业AI智能体实施落地',
  'health-management': '心脑血管健康数字化管理',
  'ai-health-fusion': 'AI+心脑血管健康融合实践'
};

const categoryColors: Record<string, string> = {
  'ai-enterprise': 'accent',
  'health-management': 'secondary',
  'ai-health-fusion': 'primary'
};

const apiCases = await getCases();

// 将 API 数据按分类分组
function groupByCategory(cases: any[]) {
  const grouped: Record<string, any[]> = {};
  cases.forEach(c => {
    const cat = c.category || 'ai-enterprise';
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push({
      title: c.title,
      background: c.background || '',
      approach: c.approach || [],
      results: c.results?.metrics || []
    });
  });
  return grouped;
}

const groupedCases = groupByCategory(apiCases);

// 构建 caseCategories
const caseCategories = apiCases.length > 0
  ? Object.entries(groupedCases).map(([catId, cases]) => ({
      id: catId,
      title: categoryTitles[catId] || catId,
      icon: categoryIcons[catId] || categoryIcons['ai-enterprise'],
      cases,
      color: categoryColors[catId] || 'accent'
    }))
  : [
    {
      id: 'ai-enterprise',
      title: '企业AI智能体实施落地',
      icon: categoryIcons['ai-enterprise'],
      cases: [
        {
          title: '某制造企业AI智能体落地',
          background: '需落地AI智能体提升办公效率，存在"技术与业务脱节、团队不会用"的痛点',
          approach: ['深度调研业务场景', '定制轻量化AI方案', '落地+数据打通', '团队实操培训'],
          results: [
            { value: '40%', label: '办公效率提升' },
            { value: '95%', label: 'AI工具使用率' }
          ]
        },
        {
          title: '某政府产业园区AI+数字化',
          background: '需落地AI智能体优化招商与企业服务，存在"数据割裂、服务效率低"的痛点',
          approach: ['整合园区数据', '定制AI智能体', '合规落地+系统对接'],
          results: [
            { value: '50%', label: '企业对接效率' },
            { value: '60%', label: '数据管理效率' }
          ]
        }
      ],
      color: 'accent'
    },
    {
      id: 'health-management',
      title: '心脑血管健康数字化管理',
      icon: categoryIcons['health-management'],
      cases: [
        {
          title: '个人心脑血管慢病管理',
          background: '45岁上班族，高血压高危因素，工作繁忙，无时间做系统健康管理',
          approach: ['数据化监测核心指标', '定制饮食/作息方案', '数字化打卡+30天跟进'],
          results: [
            { value: '正常', label: '30天血压' },
            { value: '5分钟', label: '每日监测' }
          ]
        },
        {
          title: '企业员工健康管理',
          background: '需为员工做心脑血管健康管理，存在"人数多、需求分散、效率低"的痛点',
          approach: ['定制健康数字化体系', 'AI工具辅助监测', '批量方案定制+答疑'],
          results: [
            { value: '80%', label: '健康知晓率' },
            { value: '90%+', label: '员工满意度' }
          ]
        }
      ],
      color: 'secondary'
    },
    {
      id: 'ai-health-fusion',
      title: 'AI+心脑血管健康融合实践',
      icon: categoryIcons['ai-health-fusion'],
      cases: [
        {
          title: '大健康机构AI智能化升级',
          background: '需提升心脑血管健康管理效率，存在"人工咨询量大、方案定制慢"的痛点',
          approach: ['定制AI智能体', '咨询自动化', '健康数据打通与监测'],
          results: [
            { value: '70%', label: '咨询效率提升' },
            { value: '80%', label: '方案时间缩短' },
            { value: '60%', label: '用户量提升' },
            { value: '30%', label: '成本降低' }
          ]
        }
      ],
      color: 'primary'
    }
  ];
---

<section id="cases" class="section relative overflow-hidden">
  <!-- 背景装饰 -->
  <div class="absolute inset-0 tech-grid"></div>

  <div class="container relative z-10">
    <!-- 标题 -->
    <div class="text-center mb-16">
      <span class="data-badge mb-4 inline-flex">案例成果</span>
      <h2 class="section-title mb-3">落地案例</h2>
      <p class="section-subtitle">用落地结果，证明核心能力</p>
    </div>

    <!-- 案例分类 -->
    <div class="space-y-12">
      {caseCategories.map((category, catIndex) => (
        <div>
          <!-- 分类标题 -->
          <div class="flex items-center gap-3 mb-6">
            <div class={`icon-box ${category.color === 'primary' ? 'icon-box-primary' : category.color === 'secondary' ? 'icon-box-secondary' : ''}`}>
              <Fragment set:html={category.icon} />
            </div>
            <div>
              <h3 class="text-lg font-bold text-text-primary">{category.title}</h3>
              <p class="text-xs text-text-secondary">{category.cases.length} 个案例</p>
            </div>
          </div>

          <!-- 案例卡片 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {category.cases.map((caseItem) => (
              <div class="card group">
                <!-- 案例标题 -->
                <h4 class="text-base font-semibold text-text-primary mb-4 flex items-center gap-2">
                  <div class={`w-2 h-2 rounded-full ${
                    category.color === 'primary' ? 'bg-primary' :
                    category.color === 'secondary' ? 'bg-secondary' : 'bg-accent'
                  }`}></div>
                  {caseItem.title}
                </h4>

                <!-- 项目背景 -->
                <div class="mb-4">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-xs font-medium text-text-secondary">项目背景</span>
                  </div>
                  <p class="text-sm text-text-secondary leading-relaxed pl-6">{caseItem.background}</p>
                </div>

                <!-- 核心做法 -->
                <div class="mb-5">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    <span class="text-xs font-medium text-text-secondary">核心做法</span>
                  </div>
                  <div class="flex flex-wrap gap-2 pl-6">
                    {caseItem.approach.map((step, i) => (
                      <div class="flex items-center gap-1">
                        <span class={`w-5 h-5 rounded text-xs flex items-center justify-center ${
                          category.color === 'primary' ? 'bg-primary/10 text-primary' :
                          category.color === 'secondary' ? 'bg-secondary/10 text-secondary' :
                          'bg-accent/10 text-accent'
                        }`}>{i + 1}</span>
                        <span class="text-xs text-text-secondary">{step}</span>
                        {i < caseItem.approach.length - 1 && (
                          <svg class="w-3 h-3 text-border mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                          </svg>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                <!-- 落地结果 -->
                <div class="pt-4 border-t border-border/50">
                  <div class="flex items-center gap-2 mb-3">
                    <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-xs font-medium text-text-secondary">落地结果</span>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    {caseItem.results.map((result) => (
                      <div class="text-center p-3 rounded-xl bg-gradient-to-br from-accent/5 to-purple-500/5 dark:from-accent/10 dark:to-purple-500/10">
                        <p class={`text-xl font-bold ${
                          category.color === 'primary' ? 'text-primary' :
                          category.color === 'secondary' ? 'text-secondary' : 'text-accent'
                        }`}>{result.value}</p>
                        <p class="text-xs text-text-secondary">{result.label}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

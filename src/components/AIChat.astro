---
// AI Chat组件 - 悬浮聊天窗口
// 使用智谱 GLM-4 API
---

<div id="ai-chat-widget" class="fixed bottom-6 right-6 z-50">
  <!-- 悬浮按钮 -->
  <button
    id="chat-toggle-btn"
    class="w-14 h-14 bg-gradient-to-br from-accent to-purple-600 hover:from-accent/90 hover:to-purple-600/90 rounded-full shadow-lg shadow-accent/30 flex items-center justify-center transition-all duration-300 hover:scale-105"
    aria-label="AI智能咨询"
  >
    <svg id="chat-icon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
    </svg>
    <svg id="close-icon" class="w-6 h-6 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <!-- 未读消息提示 -->
  <span id="unread-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
    1
  </span>

  <!-- 聊天窗口 -->
  <div
    id="chat-window"
    class="hidden absolute bottom-16 right-0 w-80 sm:w-96 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-border/20"
  >
    <!-- 头部 -->
    <div class="bg-gradient-to-r from-accent to-purple-600 px-4 py-3 text-white">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <div>
          <p class="font-medium text-sm">邱小亮AI顾问</p>
          <p class="text-xs text-white/80">Powered by 智谱GLM</p>
        </div>
      </div>
    </div>

    <!-- 消息区域 -->
    <div id="chat-messages" class="h-80 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-slate-900">
      <!-- 欢迎消息 -->
      <div class="flex gap-2">
        <div class="w-8 h-8 bg-accent/10 dark:bg-accent/20 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="bg-white dark:bg-slate-700 rounded-xl rounded-tl-none px-3 py-2 max-w-[80%] shadow-sm">
          <p class="text-sm text-gray-800 dark:text-gray-100">
            你好～我是邱小亮的专属AI顾问，专注<span class="text-accent font-medium">企业AI智能体落地</span>与<span class="text-secondary font-medium">心脑血管健康数字化管理</span>。请问你想咨询哪方面的问题？
          </p>
        </div>
      </div>

      <!-- 快捷问题按钮 -->
      <div class="flex flex-wrap gap-2">
        <button class="quick-question text-xs bg-white dark:bg-slate-700 border border-accent/30 text-accent px-3 py-1.5 rounded-full hover:bg-accent hover:text-white transition-colors">
          企业AI部署
        </button>
        <button class="quick-question text-xs bg-white dark:bg-slate-700 border border-secondary/30 text-secondary px-3 py-1.5 rounded-full hover:bg-secondary hover:text-white transition-colors">
          健康管理咨询
        </button>
        <button class="quick-question text-xs bg-white dark:bg-slate-700 border border-primary/30 text-primary px-3 py-1.5 rounded-full hover:bg-primary hover:text-white transition-colors">
          服务价格
        </button>
      </div>
    </div>

    <!-- 输入区域 -->
    <div class="p-3 bg-white dark:bg-slate-800 border-t border-border/20">
      <form id="chat-form" class="flex gap-2">
        <input
          type="text"
          id="chat-input"
          placeholder="输入你的问题..."
          class="flex-1 px-3 py-2 text-sm bg-gray-100 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent text-gray-800 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"
          autocomplete="off"
        />
        <button
          type="submit"
          id="send-btn"
          class="btn btn-accent text-sm px-4 py-2"
        >
          发送
        </button>
      </form>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
        或 <a href="#contact" class="text-accent hover:underline">直接预约1v1咨询</a>
      </p>
    </div>
  </div>
</div>

<script>
  // 智谱 GLM API 配置
  const ZHIPU_API_URL = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
  const ZHIPU_API_KEY = '1c40de4426254ad181027b6497f45e6f.F5MBA0b1Ow6sAipy';
  const ZHIPU_MODEL = 'glm-4-flash';

  // 系统提示词
  const SYSTEM_PROMPT = `你是邱小亮的专属AI顾问，代表邱小亮回答用户咨询。

邱小亮的核心信息：
- 17年AI+大健康+数字化转型实战经验
- 企业AI智能体实施部署专家
- 心脑血管健康数字化管理实践者
- 系统架构师、数据资产管理师
- 海南岛AI健康大使
- 楼友会创业导师
- 重庆市文旅研究会数字文旅专委会专家顾问

核心服务：
1. 企业AI智能体定制化实施部署 - 从需求调研到落地培训全流程服务
2. 心脑血管健康数字化管理方案 - 数据监测+个性化方案定制+30天跟进
3. AI+心脑血管健康融合解决方案 - 面向大健康机构的智能化升级

联系方式：
- 电话：17326050425
- 邮箱：qxl5918@126.com

回答要求：
1. 专业、友好、简洁
2. 根据用户问题推荐合适的服务
3. 引导用户预约1v1咨询获取定制方案
4. 如果涉及具体报价，建议预约咨询后根据需求评估`;

  // 聊天历史
  let messages: Array<{role: string, content: string}> = [
    { role: 'system', content: SYSTEM_PROMPT }
  ];

  // DOM元素
  const toggleBtn = document.getElementById('chat-toggle-btn');
  const chatWindow = document.getElementById('chat-window');
  const chatIcon = document.getElementById('chat-icon');
  const closeIcon = document.getElementById('close-icon');
  const chatMessages = document.getElementById('chat-messages');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const quickQuestions = document.querySelectorAll('.quick-question');
  const unreadBadge = document.getElementById('unread-badge');
  let isOpen = false;

  // 切换聊天窗口
  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      isOpen = !isOpen;
      chatWindow?.classList.toggle('hidden', !isOpen);
      chatIcon?.classList.toggle('hidden', isOpen);
      closeIcon?.classList.toggle('hidden', !isOpen);
      unreadBadge?.classList.add('hidden');

      if (isOpen) {
        chatInput?.focus();
      }
    });
  }

  // 快捷问题点击
  quickQuestions.forEach((btn) => {
    btn.addEventListener('click', () => {
      const question = btn.textContent?.trim() || '';
      if (chatInput) {
        chatInput.value = question;
      }
      chatForm?.dispatchEvent(new Event('submit'));
    });
  });

  // 发送消息
  if (chatForm) {
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = chatInput?.value.trim();
      if (!message) return;

      // 添加用户消息
      addMessage(message, 'user');
      if (chatInput) chatInput.value = '';

      // 显示加载状态
      const loadingId = addLoadingMessage();
      if (sendBtn) sendBtn.disabled = true;

      try {
        // 调用智谱 API
        const response = await callZhipuAPI(message);

        // 移除加载消息
        removeLoadingMessage(loadingId);

        // 添加AI回复
        addMessage(response, 'ai');
      } catch (error) {
        removeLoadingMessage(loadingId);
        addMessage('抱歉，网络有点问题，请稍后再试或直接预约1v1咨询。', 'ai');
      }

      if (sendBtn) sendBtn.disabled = false;
    });
  }

  // 添加消息到聊天窗口
  function addMessage(content: string, type: 'user' | 'ai') {
    const messageDiv = document.createElement('div');

    if (type === 'user') {
      messageDiv.className = 'flex gap-2 justify-end';
      messageDiv.innerHTML = `
        <div class="bg-gradient-to-r from-accent to-purple-600 text-white rounded-xl rounded-tr-none px-3 py-2 shadow-sm max-w-[80%]">
          <p class="text-sm">${escapeHtml(content)}</p>
        </div>
      `;
    } else {
      messageDiv.className = 'flex gap-2';
      messageDiv.innerHTML = `
        <div class="w-8 h-8 bg-accent/10 dark:bg-accent/20 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="bg-white dark:bg-slate-700 rounded-xl rounded-tl-none px-3 py-2 max-w-[80%] shadow-sm">
          <p class="text-sm text-gray-800 dark:text-gray-100">${escapeHtml(content)}</p>
        </div>
      `;
    }

    chatMessages?.appendChild(messageDiv);
    chatMessages?.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
  }

  // HTML转义
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // 添加加载消息
  function addLoadingMessage(): string {
    const loadingId = 'loading-' + Date.now();
    const loadingDiv = document.createElement('div');
    loadingDiv.id = loadingId;
    loadingDiv.className = 'flex gap-2';
    loadingDiv.innerHTML = `
      <div class="w-8 h-8 bg-accent/10 dark:bg-accent/20 rounded-full flex items-center justify-center flex-shrink-0">
        <svg class="w-4 h-4 text-accent animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
      <div class="bg-white dark:bg-slate-700 rounded-xl rounded-tl-none px-3 py-2 shadow-sm">
        <p class="text-sm text-gray-500 dark:text-gray-400">正在思考中...</p>
      </div>
    `;
    chatMessages?.appendChild(loadingDiv);
    chatMessages?.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
    return loadingId;
  }

  // 移除加载消息
  function removeLoadingMessage(id: string) {
    document.getElementById(id)?.remove();
  }

  // 调用智谱 GLM API
  async function callZhipuAPI(userMessage: string): Promise<string> {
    // 添加用户消息到历史
    messages.push({ role: 'user', content: userMessage });

    try {
      const response = await fetch(ZHIPU_API_URL, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ZHIPU_API_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: ZHIPU_MODEL,
          messages: messages,
          temperature: 0.7,
          max_tokens: 500,
        }),
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      const assistantMessage = data.choices?.[0]?.message?.content || '抱歉，我没理解您的问题。可以直接预约邱小亮的1v1咨询获取详细解答。';

      // 添加AI回复到历史
      messages.push({ role: 'assistant', content: assistantMessage });

      // 限制历史消息数量，保留系统提示和最近几轮对话
      if (messages.length > 10) {
        messages = [messages[0], ...messages.slice(-8)];
      }

      return assistantMessage;
    } catch (error) {
      console.error('Zhipu API error:', error);
      // 移除失败的用户消息
      messages.pop();
      throw error;
    }
  }
</script>
